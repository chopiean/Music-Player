<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spotify Music Player</title>
  <link rel="stylesheet" href="./asset/style/style.css" />
  <script src="https://kit.fontawesome.com/e4f7b1c3b0.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="app">
    <div class="main">
      <div class="playlist__header">
        <p class="playlist__title">Now Playing:</p>
        <h2 class="playlist__song-name" id="song-name">---</h2>
      </div>
      <div class="cd">
        <div class="cd__thumb" id="cd-thumb"></div>
      </div>
      <div class="controls">
        <button class="btn btn-repeat" id="btn-repeat"><i class="fa-solid fa-arrow-rotate-right"></i></button>
        <button class="btn btn-prev" id="btn-prev"><i class="fa-solid fa-backward-step"></i></button>
        <button class="btn btn-toggle-play" id="btn-play">
          <i class="fa-solid fa-play icon-play"></i>
          <i class="fa-solid fa-pause icon-pause"></i>
        </button>
        <button class="btn btn-next" id="btn-next"><i class="fa-solid fa-forward-step"></i></button>
        <button class="btn btn-random" id="btn-random"><i class="fa-solid fa-shuffle"></i></button>
      </div>
      <input type="range" id="progress" class="progress" value="0" min="0" max="100" />
      <audio id="audio"></audio>
      <div class="song-list" id="playlist"></div>
    </div>
    <footer class="footer">
      <div class="volume">
        <i class="fa-solid fa-volume-high"></i>
        <input type="range" id="volume" class="volume__slider" min="0" max="100" value="80" />
      </div>
      <div class="footer__credits">
        <span>Made by An Le</span>
        <a href="https://github.com/GiaBao-cyberpunk" target="_blank" rel="noopener noreferrer">
          <i class="fa-brands fa-github"></i>
        </a>
      </div>
    </footer>
  </div>

  <script>
    const $ = document.querySelector.bind(document)
    const $$ = document.querySelectorAll.bind(document)

    const PLAYER_STORAGE_KEY = 'F8_PLAYER'

    const playlist = $('#playlist')
    const cd = $('.cd')
    const heading = $('#song-name')
    const cdThumb = $('.cd__thumb')
    const audio = $('#audio')

    const playBtn = $('.btn-toggle-play')
    const nextBtn = $('.btn-next')
    const prevBtn = $('.btn-prev')
    const repeatBtn = $('.btn-repeat')
    const randomBtn = $('.btn-random')
    const progress = $('#progress')

    const app = {
      isPlay: false,
      isRandom: false,
      isRepeat: false,
      currentIndex: 0,
      config: JSON.parse(localStorage.getItem(PLAYER_STORAGE_KEY)) || {},
      songs: [
        {
          name: 'Lễ Đường',
          singer: 'Kai Đinh',
          path: './asset/audio/song1.mp3',
          img: './asset/img/song1.jpeg',
        },
        {
          name: 'Chưa Được Yêu Như Thế',
          singer: 'TRANG',
          path: './asset/audio/song2.mp3',
          img: './asset/img/song2.jpg',
        },
        {
          name: 'Có Nhau',
          singer: 'Thịnh Suy',
          path: './asset/audio/song3.mp3',
          img: './asset/img/song3.jpeg',
        },
        {
          name: 'Anh Sẽ Đặt Trái Tim Lên Bàn',
          singer: 'Tùng',
          path: './asset/audio/song4.mp3',
          img: './asset/img/song4.jpg',
        },
        {
          name: 'Em Không',
          singer: 'Vũ Thanh Vân',
          path: './asset/audio/song5.mp3',
          img: './asset/img/song5.jpg',
        },
        {
          name: 'Một Ngàn Nỗi Đau',
          singer: 'Văn Mai Hương x Trung Quân',
          path: './asset/audio/song6.mp3',
          img: './asset/img/song6.jpg',
        },
        {
          name: 'Từng Là Của Nhau',
          singer: 'Bảo Anh ft Táo',
          path: './asset/audio/song7.mp3',
          img: './asset/img/song7.jpg',
        },
        {
          name: 'Cầu Vĩnh Tuy',
          singer: 'Wren Evans',
          path: './asset/audio/song8.mp3',
          img: './asset/img/song8.jpg',
        },
        {
          name: 'Only',
          singer: 'LeeHi',
          path: './asset/audio/song9.mp3',
          img: './asset/img/song9.jpg',
        },
        {
          name: 'Một Bài Hát Không Vui Mấy',
          singer: 'T.R.I x Dangrangto x DONAL',
          path: './asset/audio/song10.mp3',
          img: './asset/img/song10.jpg',
        },
      ],

      setConfig: function (key, value) {
        this.config[key] = value
        localStorage.setItem(PLAYER_STORAGE_KEY, JSON.stringify(this.config))
      },

      render: function () {
        const htmls = this.songs.map((song, index) => {
          return `
            <div class="song ${index === this.currentIndex ? 'active' : ''}" data-index="${index}">
              <div class="thumb" style="background-image: url('${song.img}')"></div>
              <div class="body">
                <h3 class="title">${song.name}</h3>
                <p class="author">${song.singer}</p>
              </div>
              <div class="option">
                <i class="fa-solid fa-ellipsis"></i>
                <ul class="option__menu">
                  <li class="option__item remove">Remove this song</li>
                  <li class="option__item add">Add to playlist</li>
                </ul>
              </div>
            </div>
          `
        })
        playlist.innerHTML = htmls.join('')
      },

      defineProperties: function () {
        Object.defineProperty(this, 'currentSong', {
          get: function () {
            return this.songs[this.currentIndex]
          },
        })
      },

      handleEvents: function () {
        const _this = this
        const cdWidth = cd.offsetWidth

        // CD rotate animation
        const cdThumbAnimate = cdThumb.animate([{ transform: 'rotate(360deg)' }], {
          duration: 10000,
          iterations: Infinity,
        })
        cdThumbAnimate.pause()

        // Scroll effect to shrink CD
        document.onscroll = function () {
          const scrollTop = document.documentElement.scrollTop || window.scrollY
          const newCdWidth = cdWidth - scrollTop

          cd.style.width = newCdWidth > 0 ? newCdWidth + 'px' : 0
          cd.style.opacity = newCdWidth / cdWidth
        }

        // Play/Pause button
        playBtn.onclick = function () {
          if (_this.isPlay) {
            audio.pause()
          } else {
            audio.play()
          }
        }

        // When song is played
        audio.onplay = function () {
          _this.isPlay = true
          playBtn.classList.add('playing')
          cdThumbAnimate.play()
        }

        // When song is paused
        audio.onpause = function () {
          _this.isPlay = false
          playBtn.classList.remove('playing')
          cdThumbAnimate.pause()
        }

        // Update progress bar as audio plays
        audio.ontimeupdate = function () {
          if (audio.duration) {
            const progressPercent = Math.floor((audio.currentTime / audio.duration) * 100)
            progress.value = progressPercent
          }
        }

        // Seek song when progress bar changes
        progress.oninput = function (e) {
          const seekTime = (audio.duration / 100) * e.target.value
          audio.currentTime = seekTime
        }

        // Next button click
        nextBtn.onclick = function () {
          if (_this.isRandom) {
            _this.playRandomSong()
          } else {
            _this.nextSong()
          }
          audio.play()
          _this.render()
          _this.scrollToActiveSong()
        }

        // Previous button click
        prevBtn.onclick = function () {
          if (_this.isRandom) {
            _this.playRandomSong()
          } else {
            _this.prevSong()
          }
          audio.play()
          _this.render()
          _this.scrollToActiveSong()
        }

        // Random button toggle
        randomBtn.onclick = function () {
          _this.isRandom = !_this.isRandom
          _this.setConfig('isRandom', _this.isRandom)
          randomBtn.classList.toggle('active', _this.isRandom)
        }

        // Repeat button toggle
        repeatBtn.onclick = function () {
          _this.isRepeat = !_this.isRepeat
          _this.setConfig('isRepeat', _this.isRepeat)
          repeatBtn.classList.toggle('active', _this.isRepeat)
        }

        // When song ended
        audio.onended = function () {
          if (_this.isRepeat) {
            audio.play()
          } else {
            nextBtn.click()
          }
        }

        // Click on song or options in playlist
        playlist.onclick = function (e) {
          const songNode = e.target.closest('.song:not(.active)')
          const optionNode = e.target.closest('.option')

          // Click on song to play
          if (songNode) {
            _this.currentIndex = Number(songNode.dataset.index)
            _this.loadCurrentSong()
            _this.render()
            audio.play()
          }

          // Click on option menu items
          if (optionNode) {
            const songElement = e.target.closest('.song')
            const songIndex = Number(songElement.dataset.index)

            // Check which option was clicked
            if (e.target.classList.contains('remove')) {
              // Remove song from playlist
              _this.songs.splice(songIndex, 1)

              // Adjust currentIndex if necessary
              if (_this.currentIndex >= _this.songs.length) {
                _this.currentIndex = 0
              }

              _this.loadCurrentSong()
              _this.render()
              _this.scrollToActiveSong()
            } else if (e.target.classList.contains('add')) {
              alert(`"${_this.songs[songIndex].name}" added to your playlist!`)
            }

            e.stopPropagation()
          }
        }
      },

      scrollToActiveSong: function () {
        setTimeout(() => {
          const activeSong = $('.song.active')
          if (activeSong) {
            activeSong.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest',
            })
          }
        }, 300)
      },

      loadCurrentSong: function () {
        heading.textContent = this.currentSong.name
        cdThumb.style.backgroundImage = `url('${this.currentSong.img}')`
        audio.src = this.currentSong.path
      },

      loadConfig: function () {
        this.isRandom = this.config.isRandom || false
        this.isRepeat = this.config.isRepeat || false
      },

      nextSong: function () {
        this.currentIndex++
        if (this.currentIndex >= this.songs.length) {
          this.currentIndex = 0
        }
        this.loadCurrentSong()
      },

      prevSong: function () {
        this.currentIndex--
        if (this.currentIndex < 0) {
          this.currentIndex = this.songs.length - 1
        }
        this.loadCurrentSong()
      },

      playRandomSong: function () {
        let newIndex
        do {
          newIndex = Math.floor(Math.random() * this.songs.length)
        } while (newIndex === this.currentIndex)
        this.currentIndex = newIndex
        this.loadCurrentSong()
      },

      start: function () {
        this.loadConfig()
        this.defineProperties()
        this.handleEvents()
        this.loadCurrentSong()
        this.render()

        randomBtn.classList.toggle('active', this.isRandom)
        repeatBtn.classList.toggle('active', this.isRepeat)
      },
    }

    app.start()
  </script>
</body>
</html>
